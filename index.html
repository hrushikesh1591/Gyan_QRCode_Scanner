<!DOCTYPE html>
<html lang="en">
<head>
    <title>Bolder Event Check-In Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load Inter font for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind configuration for custom colors and fonts
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#10b981', // Emerald green
                        'secondary': '#f97316', // Orange
                    }
                }
            }
        }
    </script>
    <!-- QR Code Scanning Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* Custom styles to ensure the video feed is centered and responsive */
        body { 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f0f4f8; /* Light gray background */
        }
        #reader { 
            width: 100%; 
            max-width: 500px; 
            margin: 0 auto; 
            border-radius: 1.5rem; /* Larger rounded corners */
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2); /* Deeper shadow */
            border: 4px solid #10b981; /* Primary color border */
        }
        /* Specific styling for the status message area */
        .status-box {
            transition: all 0.4s ease-in-out;
            border-left: 8px solid;
        }
    </style>
</head>
<body class="p-4">
    
    <div class="max-w-xl w-full">
        <h1 class="text-5xl font-extrabold text-gray-900 mb-8 text-center tracking-tight">
            <span class="text-primary">E</span>vent <span class="text-primary">Check</span>-In
        </h1>

        <!-- QR Code Reader Container -->
        <div id="reader" class="mb-8"></div>

        <!-- Result/Status Display Area - Bolder and more informative -->
        <div id="status-message" class="status-box p-6 rounded-2xl shadow-xl bg-white border-primary border-opacity-50">
            <p class="text-xl font-bold text-gray-700" id="status-text">
                <span class="text-blue-500">Awaiting connection...</span>
            </p>
        </div>

        <!-- Last Scanned Data Display - Clearer separation -->
        <div class="mt-6 p-4 rounded-xl bg-white shadow-md text-left border border-gray-200">
            <p class="text-sm text-gray-500 font-semibold mb-1">Last Scanned ID:</p>
            <p class="text-lg font-mono text-gray-900 break-all" id="last-scanned-data">---</p>
        </div>
    </div>

    <script>
        // CRITICAL: Your Google Apps Script Web App URL
        const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzwSEYp0aT1N3goLqgWH45rCTYn-Z48aj0M6RJLatIomtcvGoJnFgpifdWU5E88wWic5w/exec";
        
        const statusMessageEl = document.getElementById('status-message');
        const statusTextEl = document.getElementById('status-text');
        const lastScannedDataEl = document.getElementById('last-scanned-data');

        // Initialize the scanner with improved parameters (kept from last version)
        const scanner = new Html5QrcodeScanner("reader", { 
            fps: 20, // Increased FPS for faster capture
            qrbox: { width: 300, height: 300 }, // Slightly larger scan box
            disableFlip: false 
        });

        // Function to handle successful QR code scan
        async function onScanSuccess(decodedText, decodedResult) {
            // Immediately stop scanning to prevent duplicate triggers
            scanner.clear().catch(err => console.error("Failed to stop scanner:", err));
            

            // Update UI to show we are processing
            setStatus('Sending data...', 'bg-yellow-50 text-yellow-800 border-yellow-500', decodedText);

            // 2. Send the data to the Google Sheet Webhook
            try {
                const response = await sendDataToSheet(decodedText);
                
                if (response.result === "SUCCESS") {
                    // Bold Green for Success
                    setStatus('âœ… CHECK-IN SUCCESSFUL!', 'bg-green-100 text-green-800 border-green-600', decodedText);
                } else {
                    // Bold Red for Error
                    setStatus(`âŒ LOGGING FAILED: ${response.message || 'Unknown server error.'}`, 'bg-red-100 text-red-800 border-red-600', decodedText);
                }

            } catch (error) {
                // Critical Network Error
                console.error("Network or Fetch Error:", error);
                setStatus('ðŸš¨ CONNECTION ERROR: Check internet/URL.', 'bg-gray-200 text-red-900 border-red-900', decodedText);
            }

            // 3. Restart the scanner after a short delay to allow visual feedback
            setTimeout(() => {
                // Only render if the scanner is not currently running
                if (!scanner.isScanning) {
                    scanner.render(onScanSuccess);
                    setStatus('Scan an Attendee QR Code', 'bg-white text-gray-700 border-primary', '---');
                }
            }, 4000); // 4-second pause for better viewing of status
        }

        // Helper function to update the status UI
        function setStatus(text, bgColorClass, scannedData) {
            // The class format is: [BG Color] [Text Color] [Border Color]
            const [bg, textC, borderC] = bgColorClass.split(' ');
            
            // Apply classes to elements
            statusMessageEl.className = `status-box p-6 rounded-2xl shadow-xl ${bg} ${textC} ${borderC}`;
            statusTextEl.innerText = text;
            lastScannedDataEl.innerText = scannedData;
        }


        // Function to send data to the Google Apps Script Webhook
        async function sendDataToSheet(qrData) {
            // Exponential backoff mechanism for retries
            const maxRetries = 3;
            let delay = 1000;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const payload = { qr_data: qrData };
                    const options = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    };

                    const response = await fetch(WEBHOOK_URL, options);
                    
                    if (response.ok) {
                        return await response.json(); // Successful response from script
                    }

                } catch (error) {
                    // Catch network errors and try again
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        console.log(`Retry attempt ${i + 1} failed. Retrying in ${delay / 2}ms...`);
                    } else {
                        throw error; // Throw final error if all retries fail
                    }
                }
            }
            throw new Error("Failed to connect to the server after multiple retries.");
        }

        // Start the scanner when the page loads
        scanner.render(onScanSuccess, () => {
            // Success callback after camera starts
            setStatus('Scan an Attendee QR Code', 'bg-white text-gray-700 border-primary', '---');
        }, (error) => {
            // Error callback if camera fails to start
            setStatus('ðŸ”´ Camera access failed. Ensure permission is granted.', 'bg-red-100 text-red-700 border-red-500', '---');
            console.error(error);
        });
    </script>
</body>
</html>
